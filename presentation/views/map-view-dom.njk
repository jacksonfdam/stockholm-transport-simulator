<!-- presentation/views/map-view-dom.njk -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Live Simulation Map</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css"/>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100&display=swap" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <style>
        body { background-color: #f0f2f5; }
        .map-wrapper {
            width: 100%;
            max-width: 1444px;
            margin: 2rem auto;
            padding: 1rem;
            background: #1d1f3a; /* Cor de fundo do mapa */
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #tunnelbanakarta {
            transform: scale(1);
            font-size: 14px;
            max-width: 1444px;
            height: 840px;
            overflow: hidden;
            display: block;
            position: relative;
            z-index: 100;
            margin: 0 auto;
            color: #fff;
        }
        #tunnelbanakarta ul { padding: 0; margin: 0; }
        #tunnelbanakarta ul li { list-style-type: none; }

        /* --- AJUSTE DE FONTE E ESPAÇAMENTO --- */
        #tunnelbanakarta ul li a {
            color: #b6d9c8;
            text-decoration: none;
            /* Fonte alterada conforme solicitado */
            font-family: 'Montserrat', sans-serif;
            font-size: 12px; /* Um pouco menor para caber melhor */
            font-weight: 100;
            /* Aumenta o espaçamento entre o texto e o círculo */
            padding-left: 5px;
        }

        .linje li, .linje ul { position: absolute; list-style: none; height: 8px; width: 8px; }
        .nummer {
            border-radius: 10px; z-index: 999!important; border: 2px solid #1d1f3a;
            width: 45px!important; text-align: center; color: #fafafa; font: 15px Arial,sans-serif;
            line-height: 130%; padding-left: 8px; height: 22px!important; display: inline-flex;
        }
        .stationer { position: absolute; font-weight: 700; z-index: 505; }
        .stationer li { position: relative; cursor: default; }

        /* --- CÍRCULO DA ESTAÇÃO --- */
        .stationer li:before {
            background: #fff;
            border: 3px solid #30324a;
            border-radius: 50%;
            content: "";
            display: inline-block;
            height: 15px;
            width: 15px;
            margin: 10px 0 0 -20px;
            position: absolute;
            transition: transform 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            z-index: 5;
        }

        /* --- ESTAÇÃO ATIVA --- */
        .stationer li.active:before {
            transform: scale(1.8);
            box-shadow: 0 0 10px #ffdc51;
        }

        /* Cores da borda por linha */
        #bla-linjen .stationer li:before { border-color: #268ccf !important; }
        #roda-linjen .stationer li:before { border-color: #f10d6b !important; }
        #grona-linjen .stationer li:before { border-color: #34a981 !important; }

        /* Brilho da estação ativa com a cor da linha */
        #bla-linjen .stationer li.active:before { box-shadow: 0 0 12px #a0c5f3; }
        #roda-linjen .stationer li.active:before { box-shadow: 0 0 12px #ffadcf; }
        #grona-linjen .stationer li.active:before { box-shadow: 0 0 12px #b6d9c8; }

        #centralen-t-wrapper { position: absolute; left: 787px; top: 316px; z-index: 510; }
        #centralen-t {
            background: #fff; border-radius: 30px; color: #3b73b8;
            height: 27px; text-align: center; width: 108px;
        }
        #centralen-t a { color: #30324a; font-size: 15px!important; font-weight: 600; line-height: 28px; }

        /* Rotações */
        .rot-90 { transform: rotate(90deg); }
        .rot45 { transform: rotate(45deg); }
        .rot90 { transform: rotate(90deg); }
        .rot135 { transform: rotate(135deg); }
        .rot225 { transform: rotate(225deg); }
        .rot270 { transform: rotate(270deg); }
        .rot315 { transform: rotate(315deg); }

        /* Linha Azul */
        .bla { background-color: #268ccf; z-index: 200; }
        .bla.t11-1 { width: 440px; top: 169px; left: 259px; border-radius: 10px 0 5px; }
        .bla.t11-2 { width: 285px; top: 320px; left: 625px; border-radius: 0 3px 3px 10px; }
        .bla.t10-1 { width: 250px; top: 97px; left: 115px; border-radius: 5px 0; }
        .bla.t10-2 { width: 165px; top: 183px; left: 320px; border-radius: 0 5px 3px 10px; }
        .bla.t10-3 { width: 215px; top: 259px; left: 445px; border-radius: 5px 0; }
        .bla.t10-4 { width: 290px; top: 332px; left: 620px; border-radius: 0 3px 3px 10px; }
        #t10-stationer {
            top: -47px;
            left: 240px;
            line-height: 32px;
        }
        #t11-stationer {
            top: -34px;
            left: 428px;
            line-height: 35px;
        }
        #radhuset {
            top: 313px;
            left: 638px;
        }

        #radhuset li a{
            position: relative;
            top: 31px;
            left: -10px;
        }

        .bla.nr10-a { top: 0; left: 135px; }
        .bla.nr11-a { top: 15px; left: 318px; }
        .bla.nr11-b, .bla.nr10-b { top: 309px; left: 900px; }

        /* Linha Vermelha */
        .rod { background-color: #f10d6b; z-index: 200; }
        .rod.t13-1 { width: 186px; top: 185px; left: 804px; border-radius: 0 0 8px; transform: rotate(140deg); }
        .rod.t13-2 { width: 220px; top: 350px; left: 720px; border-radius: 0 8px; }
        .rod.t13-3 { width: 407px; top: 456px; left: 422px; border-radius: 8px 0 8px 8px; }
        .rod.t13-4 { width: 248px; top: 553px; left: 367px; border-radius: 0 0 0 8px; }
        .rod.t14-1 { width: 495px; left: 570px; top: 225px; border-radius: 0 8px 0 0; }
        .rod.t14-2 { width: 251px; top: 469px; left: 569px; border-radius: 8px 0; }
        .rod.t14-3 { width: 460px; top: 615px; left: 36px; border-radius: 0 0 0 8px; }
        #t13-stationer-1 { left: 858px; line-height: 60px; top: 103px; transform: rotate(50deg); }
        #t13-stationer-1 li { transform: rotate(-50deg); }
        #t13-stationer-2 { left: 551px; line-height: 50px; top: 340px; display: flex;flex-direction: column-reverse;}
        #t14-stationer-1 { left: 789px; line-height: 32px; top: 26px; }
        #t14-stationer-2 { left: 484px;
            line-height: 50px;
            top: 504px;}
        #t14-stationer-3 { left: 258px;line-height: 42px; top: 445px; }
        .rod.nr14-a { top: 0; left: 794px; }
        .rod.nr13-a { top: 110px; left: 944px; }
        .rod.nr14-b { top: 630px; left: 393px; }
        .rod.nr13-b { top: 780px; left: 80px; }

        /* Linha Verde */
        .gron { background-color: #34a981; z-index: 100; }
        .gron.t17-1 { border-radius: 0 8px 0 0; left: 330px; top: 282px; width: 538px; }
        .gron.t17-2 { border-radius: 8px 0; left: 738px; top: 407px; width: 255px; }
        .gron.t17-3 { border-radius: 0 8px 0 0; left: 830px; top: 608px; width: 226px; }
        .gron.t18-1 { border-radius: 0 8px 0 0; left: 465px; top: 271px; width: 392px; }
        .gron.t18-2 { border-radius: 8px 0 0; left: 596px; top: 525px; width: 515px; }
        .gron.t18-3 { border-radius: 8px 0 0; left: 505px; top: 638px; width: 400px; }
        .gron.t19-1 { width: 825px; top: 293px; left: 20px; border-radius: 0 8px 0 0; }
        .gron.t19-2 { border-radius: 8px 8px 0 0; left: 734px; top: 400px; width: 215px; }
        #t17-stationer-1 {
            left: 863px;
            line-height: 32px;
            top: 335px;
        }
        #t17-stationer-2 {
            left: 929px;
            line-height: 40px;
            top: 459px;
        }
        #t18-stationer-1 {
            left: 641px;
            line-height: 40px;
            top: 138px;
        }
        #t18-stationer-2 {
            left: 864px;
            line-height: 30px;
            top: 557px;
        }
        #t19-stationer-1 {
            left: 232px;
            line-height: 33px;
            top: -10px;
        }
        #t19-stationer-2 {
            left: 689px;
            line-height: 45px;
            top: 510px;
            z-index: 999;
        }
        .gron.nr17-a { top: 269px; left: 295px; }
        .gron.nr18-a { top: 259px; left: 428px; }
        .gron.nr19-a { top: 281px; left: 10px; }
        .gron.nr17-b { top: 680px; left: 990px; }
        .gron.nr18-b { top: 780px; left: 829px; }
        .gron.nr19-b { top: 780px; left: 543px; }

        #t13-stationer-2 li a {
            position: relative;
            text-align: right;
            left: -110px;
            transform: translateX(-160px);
            white-space: nowrap;
        }

        /* Ícone do Trem */
        #train-icon {
            position: absolute;
            width: 24px;
            height: 24px;
            background-color: #ffdc51;
            border: 2px solid #1d1f3a;
            border-radius: 50%;
            box-shadow: 0 0 10px #ffdc51;
            transform: translate(-50%, -50%);
            z-index: 9999;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            visibility: hidden;
        }
    </style>

</head>
<body>
<div class="container-fluid">
    <h1 class="text-center my-4">Live Simulation Map</h1>
    <div class="map-wrapper">
        <div id="tunnelbanakarta">
            <div id="train-icon"></div>
            <div id="centralen-t-wrapper">
                <li id="centralen-t" class="stationer"><a title="T-Centralen">T-Centralen</a></li>
            </div>
            <div id="bla-linjen">
                <ul id="t10-stationer" class="stationer rot315">
                    <li><a title="Tensta">Tensta</a></li>
                    <li><a title="Rinkeby">Rinkeby</a></li>
                    <li><a title="Rissne">Rissne</a></li>
                    <li><a title="Duvbo">Duvbo</a></li>
                    <li><a title="Sundbybergs centrum">Sundbybergs&nbsp;C.</a></li>
                    <li><a title="Solna strand">Solna strand</a></li>
                    <li><a title="Huvudsta">Huvudsta</a></li>
                </ul>
                <ul id="t11-stationer" class="stationer rot315">
                    <li><a title="Husby">Husby</a></li>
                    <li><a title="Kista">Kista</a></li>
                    <li><a title="Hallonbergen">Hallonbergen</a></li>
                    <li><a title="Näckrosen">Näckrosen</a></li>
                    <li><a title="Solna centrum">Solna&nbsp;centrum</a></li>
                    <li class="bredare"><a title="Västra skogen">Västra&nbsp;Skogen</a></li>
                    <li class="bredare"><a title="Stadshagen">Stadshagen</a></li>
                </ul>
                <ul id="radhuset" class="stationer">
                    <li><a title="Rådhuset">Rådhuset</a></li>
                </ul>
                <ul class="linje">
                    <li class="nummer bla nr10-a">T10<a title="Hjulsta">Hjulsta</a></li>
                    <li class="bla t11-1 rot225">&nbsp;</li>
                    <li class="bla t11-2">&nbsp;</li>
                    <li class="nummer bla nr10-b">T10&nbsp;</li>
                    <li class="nummer bla nr11-a">T11<a title="Akalla">Akalla</a></li>
                    <li class="bla t10-1 rot225">&nbsp;</li>
                    <li class="bla t10-2">&nbsp;</li>
                    <li class="bla t10-3 rot225">&nbsp;</li>
                    <li class="bla t10-4">&nbsp;</li>
                    <li class="nummer bla nr11-b">T11<a title="Kungsträdgården">Kungsträdgården</a></li>
                </ul>
            </div>
            <div id="roda-linjen">
                <ul class="linje">
                    <li class="nummer rod nr14-a">T14<a title="Mörby centrum">Mörby&nbsp;centrum</a></li>
                    <li class="nummer rod nr13-a">T13<a title="Ropsten">Ropsten</a></li>
                    <li class="rod t13-1 rot135">&nbsp;</li>
                    <li class="rod t13-2 rot90">&nbsp;</li>
                    <li class="rod t13-3">&nbsp;</li>
                    <li class="rod t13-4 rot135">&nbsp;</li>
                    <li class="rod t14-1 rot90">&nbsp;</li>
                    <li class="rod t14-2">&nbsp;</li>
                    <li class="rod t14-3 rot135">&nbsp;</li>
                    <li class="nummer rod nr14-b">T14<a title="Fruängen">Fruängen</a></li>
                    <li class="nummer rod nr13-b">T13<a title="Norsborg">Norsborg</a></li>
                </ul>
                <ul id="t13-stationer-1" class="stationer rot45">
                    <li><a title="Gärdet">Gärdet</a></li>
                    <li><a title="Karlaplan">Karlaplan</a></li>
                    <li class="bredare"><a title="Östermalmstorg">Östermalmstorg</a></li>
                </ul>
                <ul id="t13-stationer-2" class="stationer rot-90">
                    <li><a title="Axelsberg">Axelsberg</a></li>
                    <li><a title="Örnsberg">Örnsberg</a></li>
                    <li><a title="Aspudden">Aspudden</a></li>
                    <li class="bredare"><a title="Liljeholmen">Liljeholmen</a></li>
                    <li class="bredare"><a title="Hornstull">Hornstull</a></li>
                    <li class="bredare"><a title="Zinkensdamm">Zinkensdamm</a></li>
                    <li class="bredare"><a title="Mariatorget">Mariatorget</a></li>
                </ul>
                <ul id="t14-stationer-1" class="stationer">
                    <li><a title="Danderyds sjukhus">Danderyds&nbsp;sjukhus</a></li>
                    <li><a title="Bergshamra">Bergshamra</a></li>
                    <li><a title="Universitetet">Universitetet</a></li>
                    <li><a title="Tekniska högskolan">Tekniska högskolan</a></li>
                    <li><a title="Stadion">Stadion</a></li>
                </ul>
                <ul id="t14-stationer-2" class="stationer rot45">
                    <li><a title="Midsommarkransen">Midsommarkransen</a></li>
                    <li><a title="Telefonplan">Telefonplan</a></li>
                    <li><a title="Hägerstensåsen">Hägerstensåsen</a></li>
                    <li><a title="Västertorp">Västertorp</a></li>
                </ul>
                <ul id="t14-stationer-3" class="stationer rot45">
                    <li><a title="Mälarhöjden">Mälarhöjden</a></li>
                    <li><a title="Bredäng">Bredäng</a></li>
                    <li><a title="Sätra">Sätra</a></li>
                    <li><a title="Skärholmen">Skärholmen</a></li>
                    <li><a title="Vårberg">Vårberg</a></li>
                    <li><a title="Vårby gård">Vårby&nbsp;gård</a></li>
                    <li><a title="Masmo">Masmo</a></li>
                    <li><a title="Fittja">Fittja</a></li>
                    <li><a title="Alby">Alby</a></li>
                    <li><a title="Hallunda">Hallunda</a></li>
                </ul>
            </div>
            <div id="grona-linjen">
                <ul id="t19-stationer-1" class="stationer rot270">
                    <li><a title="Hässelby strand">Hässelby&nbsp;strand</a></li>
                    <li><a title="Hässelby gård">Hässelby&nbsp;gård</a></li>
                    <li><a title="Johannelund">Johannelund</a></li>
                    <li><a title="Vällingby">Vällingby</a></li>
                    <li><a title="Råcksta">Råcksta</a></li>
                    <li><a title="Blackeberg">Blackeberg</a></li>
                    <li><a title="Islandstorget">Islandstorget</a></li>
                    <li><a title="Ängbyplan">Ängbyplan</a></li>
                    <li class="bredare-2"><a title="Åkeshov">Åkeshov</a></li>
                    <li class="bredare-2"><a title="Brommaplan">Brommaplan</a></li>
                    <li class="bredare-2"><a title="Abrahamsberg">Abrahamsberg</a></li>
                    <li class="bredare-2"><a title="Stora mossen">Stora&nbsp;mossen</a></li>
                    <li class="bredare"><a title="Alvik">Alvik</a></li>
                    <li class="bredare"><a title="Kristineberg">Kristineberg</a></li>
                    <li class="bredare"><a title="Thorildsplan">Thorildsplan</a></li>
                </ul>
                <ul id="t19-stationer-2" class="stationer rot45">
                    <li><a title="Globen">Globen</a></li>
                    <li><a title="Enskede gård">Enskede&nbsp;gård</a></li>
                    <li><a title="Sockenplan">Sockenplan</a></li>
                    <li><a title="Svedmyra">Svedmyra</a></li>
                    <li><a title="Stureby">Stureby</a></li>
                    <li><a title="Bandhagen">Bandhagen</a></li>
                    <li><a title="Högdalen">Högdalen</a></li>
                    <li><a title="Rågsved">Rågsved</a></li>
                </ul>
                <ul id="t18-stationer-1" class="stationer rot270">
                    <li class="linje-byte"><a title="Fridhemsplan">Fridhemsplan</a></li>
                    <li><a title="S:t Eriksplan">S:t&nbsp;Eriksplan</a></li>
                    <li><a title="Odenplan">Odenplan</a></li>
                    <li><a title="Rådmansgatan">Rådmansgatan</a></li>
                    <li><a title="Hötorget">Hötorget</a></li>
                </ul>
                <ul id="t18-stationer-2" class="stationer">
                    <li><a title="Blåsut">Blåsut</a></li>
                    <li><a title="Sandsborg">Sandsborg</a></li>
                    <li><a title="Skogskyrkogården">Skogskyrkogården</a></li>
                    <li><a title="Tallkrogen">Tallkrogen</a></li>
                    <li><a title="Gubbängen">Gubbängen</a></li>
                    <li><a title="Hökarängen">Hökarängen</a></li>
                    <li><a title="Farsta">Farsta</a></li>
                </ul>
                <ul id="t17-stationer-1" class="stationer">
                    <li class="bredare linje-byte"><a title="Gamla stan">Gamla&nbsp;stan</a></li>
                    <li class="bredare linje-byte"><a title="Slussen">Slussen</a></li>
                    <li><a title="Medborgarplatsen">Medborgarplatsen</a></li>
                    <li><a title="Skanstull">Skanstull</a></li>
                    <li><a title="Gullmarsplan">Gullmarsplan</a></li>
                </ul>
                <ul id="t17-stationer-2" class="stationer rot315">
                    <li class="bredare"><a title="Skärmarbrink">Skärmarbrink</a></li>
                    <li><a title="Hammarbyhöjden">Hammarbyhöjden</a></li>
                    <li><a title="Björkhagen">Björkhagen</a></li>
                    <li><a title="Kärrtorp">Kärrtorp</a></li>
                    <li><a title="Bagarmossen">Bagarmossen</a></li>
                </ul>
                <ul class="linje">
                    <li class="nummer gron nr17-a">T17</li>
                    <li class="nummer gron nr18-a">T18</li>
                    <li class="nummer gron nr19-a">T19</li>
                    <li class="gron t17-1">&nbsp;</li>
                    <li class="gron t17-2 rot90">&nbsp;</li>
                    <li class="gron t17-3 rot225">&nbsp;</li>
                    <li class="gron t18-1">&nbsp;</li>
                    <li class="gron t18-2 rot90">&nbsp;</li>
                    <li class="gron t19-1">&nbsp;</li>
                    <li class="gron t19-2 rot90">&nbsp;</li>
                    <li class="gron t18-3 rot135">&nbsp;</li>
                    <li class="nummer gron nr17-b">T17<a title="Skarpnäck">Skarpnäck</a></li>
                    <li class="nummer gron nr18-b">T18<a title="Farsta strand">Farsta&nbsp;strand</a></li>
                    <li class="nummer gron nr19-b">T19<a title="Hagsätra">Hagsätra</a></li>
                </ul>
            </div>

        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const trainIcon = document.getElementById('train-icon');
        const allStationLinks = document.querySelectorAll('#tunnelbanakarta .stationer a');
        let currentActiveStation = null;

        function findStationElement(stationName) {
            const normalizedName = stationName.trim().replace(/\s+/g, ' ');
            for (const link of allStationLinks) {
                if (link.textContent.trim().replace(/\s+/g, ' ') === normalizedName) {
                    return link.parentElement;
                }
            }
            return null;
        }

        function getAbsolutePosition(element) {
            const rect = element.getBoundingClientRect();
            const mapContainer = document.getElementById('tunnelbanakarta');
            const mapRect = mapContainer.getBoundingClientRect();

            return {
                x: rect.left - mapRect.left + (rect.width / 2),
                y: rect.top - mapRect.top + (rect.height / 2)
            };
        }

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const ws = new WebSocket(`${wsProtocol}//${window.location.host}`);

        ws.onopen = () => console.log('Connected to WebSocket for map updates.');

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.type === 'update') {
                const stationName = data.currentStop.name;
                const stationElement = findStationElement(stationName); // stationElement é o <li>

                if (stationElement) {
                    const pos = getAbsolutePosition(stationElement);

                    trainIcon.style.left = `${pos.x}px`;
                    trainIcon.style.top = `${pos.y}px`;
                    trainIcon.style.visibility = 'visible';

                    if (currentActiveStation) {
                        currentActiveStation.classList.remove('active');
                    }

                    stationElement.classList.add('active');

                    currentActiveStation = stationElement;

                } else {
                    console.warn(`Map element for station '${stationName}' not found.`);
                }
            }
        };
    });
</script>

</body>
</html>